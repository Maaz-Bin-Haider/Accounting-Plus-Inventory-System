{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Add this FIRST, before CSS -->
    <script>
            // Immediately apply dark mode before any rendering
            (function() {
                if (localStorage.getItem('theme') === 'dark') {
                    document.documentElement.classList.add('dark-mode');
                }
            })();
    </script>
    <script>
            // Also add to body synchronously
            if (localStorage.getItem('theme') === 'dark') {
                document.write('<script>document.body?.classList.add("dark-mode");<\/script>');
            }
    </script>
  <title>{% block title %}{% endblock title %}</title>
  
  <!-- Excel File Generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Your global CSS -->
  <link rel="stylesheet" href="{% static 'css/base_styling.css' %}">

  <!-- Dark Mode Css -->
  <link rel="stylesheet" href="{% static 'css/dark_mode.css' %}">

  {% block SeperateCssFile %}{% endblock SeperateCssFile %}

  <style>
    
    
  </style>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <!-- Fixed Header -->
        <div class="sidebar-header">
            <h2><i class="fa-solid fa-coins"></i> Finance</h2>
            <div class="sidebar-search">
            <input type="text" id="sidebarSearch" placeholder="Search..." onkeyup="filterNavLinks()" />
            <i class="fa-solid fa-magnifying-glass"></i>
            </div>
        </div>

        <!-- Scrollable Nav -->
        <div class="sidebar-scroll">
            <nav class="nav-links">
            <a href="{% url 'home:home' %}" class="{% if request.resolver_match.url_name == 'home' or request.resolver_match.url_name == 'home_redirect' %}active{% endif %}">
                <i class="fa-solid fa-house"></i> Dashboard
            </a>
            <a href="{% url 'sale:sales' %}" class="{% if request.resolver_match.url_name == 'sales' %}active{% endif %}">
                <i class="fa-solid fa-cart-arrow-down"></i> Sales
            </a>
            <a href="{% url 'purchase:purchasing' %}" class="{% if request.resolver_match.url_name == 'purchasing' %}active{% endif %}">
                <i class="fa-solid fa-bag-shopping"></i> Purchases
            </a>
            <a href="{% url 'payments:payment' %}" class="{% if request.resolver_match.url_name == 'payment' %}active{% endif %}">
                <i class="fa-solid fa-credit-card"></i> Payments
            </a>
            <a href="{% url 'receipts:receipt' %}" class="{% if request.resolver_match.url_name == 'receipt' %}active{% endif %}">
                <i class="fa-solid fa-receipt"></i> Receipts
            </a>
            <a href="{% url 'saleReturn:create_sale_return' %}" class="{% if request.resolver_match.url_name == 'create_sale_return' %}active{% endif %}">
                <i class="fa-solid fa-rotate-left"></i> Sale Return
            </a>
            <a href="{% url 'purchaseReturn:create_purchase_return' %}" class="{% if request.resolver_match.url_name == 'create_purchase_return' %}active{% endif %}">
                <i class="fa-solid fa-rotate-right"></i> Purchase Return
            </a>
            <a href="{% url 'items:add_new_item' %}" class="{% if request.resolver_match.url_name == 'add_new_item' %}active{% endif %}">
                <i class="fa-solid fa-box"></i> Items
            </a>
            <a href="{% url 'parties:add_new_party' %}" class="{% if request.resolver_match.url_name == 'add_new_party' %}active{% endif %}">
                <i class="fa-solid fa-users"></i> Parties
            </a>
            <a href="{% url 'accountsReports:detailed_ledger' %}" class="{% if request.resolver_match.url_name == 'detailed_ledger' %}active{% endif %}">
                <i class="fa-solid fa-book-open"></i> Accounts Reports
            </a>
            <a href="{% url 'accountsReports:stock_report' %}" class="{% if request.resolver_match.url_name == 'stock_report' %}active{% endif %}">
                <i class="fa-solid fa-warehouse"></i> Stock Reports
            </a>
            <a href="{% url 'accountsReports:company_valuation' %}" class="{% if request.resolver_match.url_name == 'company_valuation' %}active{% endif %}">
                <i class="fa-solid fa-chart-pie"></i> Profit Reports
            </a>
            </nav>
        </div>

        <!-- Footer -->
        <div class="sidebar-footer">
            <div class="user_name"><i class="fa-solid fa-user"></i>  <span id="username">-</span></div>
            <hr>
            
            <!-- Dark Mode Toggle -->
            <button class="theme-toggle" id="themeToggle">
                <i class="fa-solid fa-moon" id="themeIcon"></i>
                <span id="themeText">Dark Mode</span>
            </button>
            <a href="{% url 'authentication:logout' %}" class="logout-link">
            <i class="fa-solid fa-right-from-bracket"></i> Logout
            </a>
        </div>
    </aside>


    <!-- Main Content -->
    <main class="main-content">
      <i class="fa-solid fa-bars menu-toggle" id="menuToggle"></i>

      {% block body %}
      {% endblock body %}
    </main>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    function filterNavLinks() {
    const query = document.getElementById("sidebarSearch").value.toLowerCase();
    document.querySelectorAll(".nav-links a").forEach(link => {
        const text = link.textContent.toLowerCase();
        link.classList.toggle("hidden-link", !text.includes(query));
    });
    }
   </script>
  <!-- JS for menu toggle -->
  <script>
    const toggle = document.getElementById("menuToggle");
    const sidebar = document.querySelector(".sidebar");
    toggle.addEventListener("click", () => {
      sidebar.classList.toggle("open");
    });
  </script>
  {% if messages %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            {% for message in messages %}
                {% if 'error' in message.tags %}
                Swal.fire({
                    icon: "error",
                    title: "Access Denied",
                    text: "{{ message|escapejs }}",
                });
                {% endif %}
            {% endfor %}
        });
    </script>
  {% endif %} 
    <script>
        async function fetchCurrentUser() {
            try {
                const response = await fetch("/authentication/current/user/", {
                    method: "GET",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                    },
                });

                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }

                const data = await response.json();

                // Update HTML dynamically
                document.getElementById("username").textContent = data.username;
            } catch (error) {
                console.error("Fetch error:", error);
            }
        }

        // Call once immediately
        fetchCurrentUser();

        // Call every 3 seconds (live update)
        setInterval(fetchCurrentUser, 3000);
    </script>
    <!-- Dark Mode Script -->
    <script src="{% static 'js/dark_mode.js' %}"></script>

</body>
</html>
